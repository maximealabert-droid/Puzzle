<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Puzzle</title>

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  margin:0;
  height:100%;
  background:#111;
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  overflow:hidden;
}

button,select,label{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  background:#444;
  color:#fff;
  font-size:14px;
}

input[type="file"]{display:none}

#root{
  position:fixed;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:10px;
}

#welcome{
  display:flex;
  flex-direction:column;
  gap:15px;
  text-align:center;
}

#app{
  width:100%;
  height:100%;
  max-width:1600px;
  display:none;
}

.topbar{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}

#timer{color:#aaa;font-size:13px}

.grids{
  display:flex;
  flex-direction:column;
  gap:10px;
  align-items:center;
}

@media (orientation: landscape){
  .grids{
    flex-direction:row;
    justify-content:center;
    align-items:flex-start;
  }
}

.grille1,.grille2{
  display:grid;
}

.grille1{gap:2px}
.grille2{gap:0}

.cell{
  background:#000;
  position:relative;
  overflow:hidden;
}

.grille2 .cell{
  box-shadow:inset 0 0 0 1px #444;
}

.cell.x{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' preserveAspectRatio='none'%3E%3Cline x1='0' y1='0' x2='100' y2='100' stroke='rgba(200,200,200,0.35)' stroke-width='1'/%3E%3Cline x1='0' y1='100' x2='100' y2='0' stroke='rgba(200,200,200,0.35)' stroke-width='1'/%3E%3C/svg%3E");
}

.piece{
  width:100%;
  height:100%;
  object-fit:cover;
  touch-action:none;
}

.dragging{
  position:fixed;
  pointer-events:none;
  transform:translate(-50%,-50%);
  z-index:1000;
}

#overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.92);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1500;
  padding:16px;
}
#overlay img{
  max-width:95vw;
  max-height:90vh;
  border-radius:10px;
}

#popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.9);
  display:none;
  align-items:center;
  justify-content:center;
}

.popup-box{
  background:#222;
  padding:20px;
  border-radius:12px;
  text-align:center;
}

</style>
</head>

<body>
<div id="root">

<div id="welcome">
  <div style="font-size:28px">üß© Puzzle</div>

  <select id="sizeSelect">
    <option value="6">36 Pi√®ces</option>
    <option value="7">49 Pi√®ces</option>
    <option value="8">64 Pi√®ces</option>
    <option value="9">81 Pi√®ces</option>
  </select>

  <label for="upload">Choisir une image</label>
  <input type="file" id="upload" accept="image/*">
</div>

<div id="app">
  <div class="topbar">
    <button id="btnPreview">Voir image</button>
    <div id="timer">0s</div>
    <button id="checkBtn" style="display:none">V√©rifier</button>
  </div>

  <div class="grids">
    <div id="grille1" class="grille1"></div>
    <div id="grille2" class="grille2"></div>
  </div>
</div>

</div>

<div id="overlay"><img id="previewImg"></div>

<div id="popup">
  <div class="popup-box">
    <div id="popupTitle"></div>
    <div id="popupTime" style="margin:10px 0"></div>
    <button onclick="popup.style.display='none'">Fermer</button>
  </div>
</div>

<img id="sourceImage" style="display:none">

<script>

let COLS=6, ROWS=6, TOTAL=36;
let tiles=[];
let dragged=null, origin=null;
let startTime=0, timerInterval=null;
let tileRatio=1;

const sizeSelect=document.getElementById("sizeSelect");
const upload=document.getElementById("upload");
const welcome=document.getElementById("welcome");
const app=document.getElementById("app");
const grille1=document.getElementById("grille1");
const grille2=document.getElementById("grille2");
const sourceImage=document.getElementById("sourceImage");
const timerDisplay=document.getElementById("timer");
const checkBtn=document.getElementById("checkBtn");
const popup=document.getElementById("popup");
const popupTitle=document.getElementById("popupTitle");
const popupTime=document.getElementById("popupTime");
const overlay=document.getElementById("overlay");
const previewImg=document.getElementById("previewImg");
const btnPreview=document.getElementById("btnPreview");

function formatTime(s){
  s=Math.floor(s);
  if(s<60) return s+"s";
  const m=Math.floor(s/60);
  const rs=s%60;
  if(m<60) return m+"m "+rs+"s";
  const h=Math.floor(m/60);
  return h+"h "+(m%60)+"m "+rs+"s";
}

function startTimer(){
  startTime=Date.now();
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    timerDisplay.textContent=formatTime((Date.now()-startTime)/1000);
  },1000);
}

function stopTimer(){ clearInterval(timerInterval); }

sizeSelect.onchange=()=>{
  COLS=parseInt(sizeSelect.value);
  ROWS=COLS;
  TOTAL=COLS*ROWS;
};

function layout(){
  const w = window.innerWidth;
  const h = window.innerHeight;
  const topbarH = document.querySelector(".topbar").offsetHeight;
  const availH = h - topbarH - 40;
  const gap = 10;
  const isLandscape = w > h;

  let size;

  if(isLandscape){
    const maxByWidth = (w - gap*3) / 2;
    const maxByHeight = availH / tileRatio;
    size = Math.min(maxByWidth, maxByHeight);
  } else {
    // iPad portrait safe calculation
    const maxByWidth = w - 20;
    const maxByHeight = (availH - gap) / (2 * tileRatio);
    size = Math.min(maxByWidth, maxByHeight);
  }

  grille1.style.width = size + "px";
  grille2.style.width = size + "px";
}

function createGrids(){
  grille1.innerHTML="";
  grille2.innerHTML="";
  grille1.style.gridTemplateColumns="repeat("+COLS+",1fr)";
  grille2.style.gridTemplateColumns="repeat("+COLS+",1fr)";
  for(let i=0;i<TOTAL;i++){
    const a=document.createElement("div");
    a.className="cell x";
    grille1.appendChild(a);
    const b=document.createElement("div");
    b.className="cell x";
    b.dataset.index=i;
    grille2.appendChild(b);
  }
}

function sliceImage(img){
  tiles=[];
  const canvas=document.createElement("canvas");
  const ctx=canvas.getContext("2d");
  const tileW=Math.floor(img.naturalWidth/COLS);
  const tileH=Math.floor(img.naturalHeight/ROWS);
  tileRatio = tileH / tileW;
  canvas.width=tileW;
  canvas.height=tileH;

  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      ctx.clearRect(0,0,tileW,tileH);
      ctx.drawImage(img,c*tileW,r*tileH,tileW,tileH,0,0,tileW,tileH);
      tiles.push(canvas.toDataURL());
    }
  }

  const ratioStr=tileW+" / "+tileH;
  document.querySelectorAll(".cell").forEach(cell=>cell.style.aspectRatio=ratioStr);
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

function renderPieces(){
  const order=shuffle([...Array(TOTAL).keys()]);
  const cells=[...grille1.children];
  order.forEach((i,index)=>{
    const img=document.createElement("img");
    img.src=tiles[i];
    img.className="piece";
    img.dataset.correct=i;
    img.onpointerdown=startDrag;
    cells[index].appendChild(img);
  });
}

function startDrag(e){
  dragged=e.target;
  origin=dragged.parentElement;
  const rect=dragged.getBoundingClientRect();
  dragged.style.width=rect.width+"px";
  dragged.style.height=rect.height+"px";
  dragged.classList.add("dragging");
  move(e);
  document.addEventListener("pointermove",move,{passive:false});
  document.addEventListener("pointerup",drop,{passive:false});
}

function move(e){
  if(!dragged)return;
  e.preventDefault();
  dragged.style.left=e.clientX+"px";
  dragged.style.top=e.clientY+"px";
}

function drop(e){
  if(!dragged)return;
  e.preventDefault();
  const cells=[...document.querySelectorAll(".cell")];
  let target=null;
  for(const cell of cells){
    const rect=cell.getBoundingClientRect();
    if(e.clientX>rect.left&&e.clientX<rect.right&&e.clientY>rect.top&&e.clientY<rect.bottom){
      if(!cell.firstChild){target=cell;break;}
    }
  }
  if(target)target.appendChild(dragged);
  else origin.appendChild(dragged);

  dragged.classList.remove("dragging");
  dragged.style="";
  dragged=null;
  origin=null;

  checkBtn.style.display=[...grille2.children].every(c=>c.firstChild)?"inline-block":"none";

  document.removeEventListener("pointermove",move);
  document.removeEventListener("pointerup",drop);
}

function checkPuzzle(){
  const cells=[...grille2.children];
  let correct=true;
  for(const cell of cells){
    const p=cell.firstChild;
    if(!p||parseInt(p.dataset.correct)!==parseInt(cell.dataset.index)){
      correct=false;
      break;
    }
  }
  if(correct){
    stopTimer();
    popupTitle.textContent="Bravo üéâ";
  }else{
    popupTitle.textContent="Dommage ‚ùå";
  }
  popupTime.textContent="Temps : "+formatTime((Date.now()-startTime)/1000);
  popup.style.display="flex";
}

checkBtn.onclick=checkPuzzle;

btnPreview.onclick=()=>overlay.style.display="flex";
overlay.onclick=()=>overlay.style.display="none";

upload.onchange=(e)=>{
  const file=e.target.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=(evt)=>{
    sourceImage.src=evt.target.result;
    previewImg.src=evt.target.result;
  };
  reader.readAsDataURL(file);
};

sourceImage.onload=()=>{
  welcome.style.display="none";
  app.style.display="block";
  createGrids();
  sliceImage(sourceImage);
  renderPieces();
  startTimer();
  layout();
};

window.addEventListener("resize",layout);

</script>

</body>
</html>
